# Pseudotime Analysis 
library(Seurat)
library(slingshot)
library(DelayedMatrixStats)
library(rgl)

so.pk <- readRDS("your dir")


#  UMAP 3D - necessary to slingshot 3D
so.pk <- RunUMAP(so.pk, dims = 1:10, n.components = 3)


# Subsets original object to just IDC so gametocytes doesn't influence trajectory
Idents(so.pk) <- "seurat_clusters"
so.idc <- subset(so.pk, idents = c(0, 1, 2, 3, 4, 5, 6, 7, 8))
sling_data <- slingshot(Embeddings(so.idc, "umap"), clusterLabels = so.idc$seurat_clusters, start.clus = "3")
sling_data <- SlingshotDataSet(sling_data)
plot3d.SlingshotDataSet(sling_data)
cell_id <- as.data.frame(slingBranchID(sling_data))

pseudotime_df <- as.data.frame(slingPseudotime(sling_data))
pseudotime_df$cell <- rownames(pseudotime_df)

# Adds pseudotime metadata to subset object
ind <- colnames(so.idc) %in% pseudotime_df$cell
trajectory <- pseudotime_df$Lineage1
so.idc@meta.data$pseudotime <- ifelse(colnames(so.idc) %in% pseudotime_df$cell, trajectory, NA)

# Creates trajectory plot
my_cols <- c("#FFA500", "#440154FF")
FeaturePlot(so.idc, features = "pseudotime", reduction = "umap", dims = c(2,3), cols = my_cols, pt.size = 1.5)

# Adds pseudotime metadata to original object
pt_vector <- setNames(pseudotime_df$Lineage1, pseudotime_df$cell)
so.pk$idc_pseudotime <- NA  # Initialize with NA
cells_to_update <- intersect(colnames(so.pk), names(pt_vector))
so.pk$idc_pseudotime[match(cells_to_update, colnames(so.pk))] <- pt_vector[cells_to_update]
FeaturePlot(so.pk, features = "idc_pseudotime", reduction = "umap", dims = c(3,2), cols = my_cols, pt.size = 1.5)

# Saves original object with pseudotime data
saveRDS(so.pk, "C:/TPA/filtered_for_R/S.O.pkh.harmony.pseudo.rds")

# Creates a pseudotime expression matrix and saves
# This will be used later to plot pseudotime gene expression
gene_exp <- as.data.frame(so.pk@assays$RNA$counts)
ind <- which(pseudotime_df$cell %in% rownames(cell_id))
idc_pseudotime <- pseudotime_df[ind, c("Lineage1", "cell")]
temp <- idc_pseudotime[order(idc_pseudotime$Lineage1), ]
ordered_cells <- rownames(temp)
idc_pseudotime <- as.data.frame(t(idc_pseudotime))
ind2 <- which(colnames(gene_exp) %in% rownames(cell_id))
idc_pseudotime <- rbind(idc_pseudotime, gene_exp[, ind2])
idc_pseudotime <- idc_pseudotime[, ordered_cells]
saveRDS(idc_pseudotime, "C:/TPA/filtered_for_R/idc.S.O.pkh.harmony.pseudo.rds")
